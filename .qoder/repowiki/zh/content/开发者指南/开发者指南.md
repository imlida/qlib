# 开发者指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [code_standard_and_dev_guide.rst](file://docs/developer/code_standard_and_dev_guide.rst)
- [how_to_build_image.rst](file://docs/developer/how_to_build_image.rst)
- [.pre-commit-config.yaml](file://.pre-commit-config.yaml)
- [pyproject.toml](file://pyproject.toml)
- [Makefile](file://Makefile)
- [Dockerfile](file://Dockerfile)
- [build_docker_image.sh](file://build_docker_image.sh)
- [pytest.ini](file://tests/pytest.ini)
- [test_all_pipeline.py](file://tests/test_all_pipeline.py)
- [config.py](file://qlib/tests/config.py)
- [data.py](file://qlib/tests/data.py)
</cite>

## 目录
1. [简介](#简介)
2. [开发环境搭建](#开发环境搭建)
3. [代码贡献流程](#代码贡献流程)
4. [编码规范与代码格式化](#编码规范与代码格式化)
5. [测试架构与测试运行](#测试架构与测试运行)
6. [Docker开发环境](#docker开发环境)
7. [扩展系统：添加新模型、数据源或策略](#扩展系统添加新模型数据源或策略)
8. [PR提交规范](#pr提交规范)

## 简介

本指南旨在为希望为QLib项目做出贡献的开发者提供全面的指导。内容涵盖从开发环境配置、代码贡献流程、编码规范到测试运行和系统扩展的各个方面。QLib是一个面向人工智能的量化投资平台，支持监督学习、市场动态建模和强化学习等多种机器学习范式。本指南将帮助您快速上手，确保您的贡献符合项目标准。

## 开发环境搭建

为了开始对QLib进行开发，您需要正确设置开发环境。推荐使用Conda来管理Python环境，以避免依赖冲突。

### 通过源码安装（开发模式）

对于开发者，建议使用可编辑模式安装QLib，这样可以实时反映代码更改，无需重新安装。

```bash
git clone https://github.com/microsoft/qlib.git
cd qlib
pip install -e ".[dev]"
```

此命令会安装QLib及其开发依赖，包括`pytest`、`sphinx`等工具，便于进行测试和文档构建。

### 安装特定可选依赖

QLib根据功能提供了多个可选依赖组，您可以通过`[group]`语法安装：
- `rl`: 安装强化学习相关依赖（如`torch`, `tianshou`）。
- `lint`: 安装代码检查工具（如`black`, `pylint`, `flake8`）。
- `docs`: 安装文档构建工具（如`sphinx`）。
- `test`: 安装测试数据收集器（如`baostock`, `yahooquery`）。

例如，安装强化学习依赖：
```bash
pip install -e ".[rl]"
```

**Section sources**
- [README.md](file://README.md#L192-L206)
- [pyproject.toml](file://pyproject.toml#L59-L108)
- [Makefile](file://Makefile#L76-L107)

## 代码贡献流程

向QLib贡献代码的流程如下：

1.  **Fork仓库**：在GitHub上Fork QLib仓库到您的个人账户。
2.  **克隆代码**：将您的Fork克隆到本地。
3.  **创建分支**：基于`main`分支创建一个新的功能或修复分支。
4.  **进行修改**：实现您的功能或修复Bug。
5.  **格式化代码**：确保代码符合编码规范（见下文）。
6.  **运行测试**：在提交前运行相关测试，确保没有引入新的问题。
7.  **提交更改**：使用符合规范的提交信息（commit message）提交更改。
8.  **推送分支**：将您的分支推送到您的Fork。
9.  **创建PR**：在GitHub上从您的分支创建一个Pull Request到`microsoft/qlib`的`main`分支。

项目维护者会审查您的PR，可能会提出修改建议。请根据反馈进行修改，直到PR被合并。

**Section sources**
- [README.md](file://README.md#L580-L622)

## 编码规范与代码格式化

QLib项目强制执行严格的代码风格，以确保代码库的一致性和可读性。贡献者必须遵守以下规范。

### 代码格式化（pre-commit）

QLib使用`pre-commit`框架来自动化代码格式化和检查。这确保了每次提交的代码都符合项目标准。

**配置pre-commit：**
```bash
# 安装开发依赖（包含pre-commit）
pip install -e ".[dev]"

# 安装pre-commit钩子
pre-commit install
```

安装后，每次执行`git commit`时，`pre-commit`会自动运行以下工具：
- **Black**: 自动格式化Python代码，统一代码风格。
- **Flake8**: 检查代码风格和潜在错误。

您也可以手动运行这些检查：
```bash
# 手动运行所有pre-commit钩子
pre-commit run --all-files

# 或使用Makefile中的命令
make lint
```

### 编码规范

除了自动格式化，开发者还需注意以下规范：
- **文档字符串（Docstring）**：请使用[Numpydoc风格](https://numpydoc.readthedocs.io/en/latest/format.html)编写函数和类的文档。
- **Pylint检查**：CI流程会使用`pylint`进行代码质量检查。虽然部分限制可能不完全合理，但应尽量遵守。对于必须忽略的警告，可以使用`# pylint: disable=E1130`这样的注释。
- **类型提示**：鼓励使用Python的类型提示（Type Hints）来提高代码的可维护性。

**Section sources**
- [code_standard_and_dev_guide.rst](file://docs/developer/code_standard_and_dev_guide.rst#L1-L53)
- [.pre-commit-config.yaml](file://.pre-commit-config.yaml#L1-L13)
- [Makefile](file://Makefile#L117-L176)

## 测试架构与测试运行

QLib拥有一个全面的测试套件，用于确保代码的稳定性和正确性。

### 测试目录结构

项目的测试代码位于`tests/`目录下，其结构与`qlib/`源码目录相对应：
- `tests/backtest/`: 回测模块的测试。
- `tests/data_mid_layer_tests/`: 数据中间层（如`dataloader`, `dataset`）的测试。
- `tests/model/`: 模型组件的测试。
- `tests/rl/`: 强化学习模块的测试。
- `tests/conftest.py`: Pytest的配置文件，用于全局设置。
- `tests/pytest.ini`: Pytest的配置文件，定义标记和警告过滤。

### 运行测试套件

您可以使用`pytest`命令来运行测试。

**运行所有测试：**
```bash
pytest tests/
```

**运行特定模块的测试：**
```bash
# 运行回测模块的测试
pytest tests/backtest/

# 运行模型模块的测试
pytest tests/model/
```

**使用标记运行测试：**
项目中使用了`@pytest.mark.slow`标记耗时较长的测试。您可以选择性地运行或跳过它们：
```bash
# 只运行非慢速测试
pytest tests/ -m "not slow"

# 只运行慢速测试
pytest tests/ -m "slow"
```

**运行端到端工作流测试：**
`test_all_pipeline.py`文件包含一个完整的端到端测试，涵盖了从模型训练、信号生成到回测分析的整个流程。
```bash
pytest tests/test_all_pipeline.py
```

**Section sources**
- [pytest.ini](file://tests/pytest.ini#L1-L7)
- [test_all_pipeline.py](file://tests/test_all_pipeline.py#L1-L192)
- [config.py](file://qlib/tests/config.py#L1-L168)
- [data.py](file://qlib/tests/data.py#L1-L212)

## Docker开发环境

QLib提供了Docker镜像，为开发者提供了一个预配置的、一致的开发环境。

### 构建Docker镜像

项目根目录下的`Dockerfile`用于构建镜像。通过`--build-arg`参数可以选择构建版本。

**构建稳定版镜像（使用pip安装）：**
```bash
docker build -t qlib_image:stable -f ./Dockerfile .
```

**构建开发版镜像（使用源码安装）：**
```bash
docker build --build-arg IS_STABLE=no -t qlib_image:nightly -f ./Dockerfile .
```

### 使用Docker镜像

构建或拉取镜像后，可以按以下步骤使用：

1.  **启动容器：**
    ```bash
    docker run -it --name qlib_dev -v /path/to/local/code:/app qlib_image:stable
    ```
    此命令将本地代码目录挂载到容器内的`/app`路径，便于开发。

2.  **在容器内运行命令：**
    进入容器后，您可以像在本地一样运行QLib脚本：
    ```bash
    python scripts/get_data.py qlib_data --target_dir ~/.qlib/qlib_data/cn_data --region cn
    python qlib/cli/run.py examples/benchmarks/LightGBM/workflow_config_lightgbm_Alpha158.yaml
    ```

3.  **管理容器：**
    - **退出容器**：输入`exit`。
    - **重启容器**：`docker start -i -a qlib_dev`。
    - **停止容器**：`docker stop qlib_dev`。
    - **删除容器**：`docker rm qlib_dev`。

**自动化构建脚本：**
项目提供了`build_docker_image.sh`脚本，可以交互式地选择构建版本（稳定版或夜版）并上传到Docker Hub。

**Section sources**
- [how_to_build_image.rst](file://docs/developer/how_to_build_image.rst#L1-L82)
- [Dockerfile](file://Dockerfile#L1-L32)
- [build_docker_image.sh](file://build_docker_image.sh#L1-L32)
- [README.md](file://README.md#L320-L350)

## 扩展系统：添加新模型、数据源或策略

QLib的设计是模块化的，鼓励社区贡献新的功能。以下是添加新组件的指导。

### 添加新模型

1.  **创建模型文件**：在`qlib/contrib/model/`目录下创建新的Python文件，例如`my_model.py`。
2.  **实现模型类**：模型类应继承自`qlib.model.base.Model`，并实现`fit`和`predict`方法。
3.  **注册模型**：确保模型可以通过配置文件被`init_instance_by_config`函数初始化。
4.  **编写测试**：在`tests/model/`下添加相应的单元测试。
5.  **更新文档**：在`examples/benchmarks/`中添加一个示例YAML配置文件，并更新相关文档。

### 添加新数据源

1.  **创建数据处理器**：在`qlib/contrib/data/`目录下，实现`Handler`、`Processor`等类来处理原始数据。
2.  **数据格式转换**：使用`scripts/get_data.py`或自定义脚本将数据转换为QLib的二进制格式。
3.  **集成到Dataset**：确保新的数据源可以被`DatasetH`类加载。
4.  **验证数据健康**：使用`scripts/check_data_health.py`脚本检查数据的完整性。

### 添加新策略

1.  **实现策略类**：在`qlib/contrib/strategy/`目录下创建新的策略类，继承自`qlib.strategy.base.SimulatedStrategyBase`。
2.  **定义决策逻辑**：在`generate_orders`方法中实现您的交易逻辑。
3.  **集成测试**：将新策略集成到工作流配置中，通过回测验证其效果。

**Section sources**
- [README.md](file://README.md#L427-L454)
- [README.md](file://README.md#L508-L507)
- [README.md](file://README.md#L513-L515)

## PR提交规范

为了保持提交历史的清晰和可追溯性，请遵循以下PR提交规范：

1.  **清晰的标题**：PR标题应简洁明了地描述更改内容。
2.  **详细的描述**：在PR描述中，说明：
    - 为什么需要这个更改（动机）。
    - 如何实现的（技术细节）。
    - 是否包含破坏性变更。
    - 如何测试此更改。
3.  **关联Issue**：如果PR解决了某个Issue，请在描述中使用`Fixes #123`或`Closes #123`来关联。
4.  **代码审查**：准备好接受代码审查，并根据维护者的反馈进行修改。
5.  **CI通过**：确保您的PR通过了所有CI检查（代码格式、lint、测试等）。

遵循这些规范将有助于您的PR被更快地审查和合并。

**Section sources**
- [README.md](file://README.md#L580-L622)