# 教程与示例

<cite>
**本文档中引用的文件**  
- [README.md](file://examples/benchmarks/README.md)
- [ALSTM/README.md](file://examples/benchmarks/ALSTM/README.md)
- [Transformer/README.md](file://examples/benchmarks/Transformer/README.md)
- [LSTM/README.md](file://examples/benchmarks/LSTM/README.md)
- [MLP/README.md](file://examples/benchmarks/MLP/README.md)
- [Linear/README.md](file://examples/benchmarks/Linear/README.md)
- [workflow_config_alstm_Alpha158.yaml](file://examples/benchmarks/ALSTM/workflow_config_alstm_Alpha158.yaml)
- [workflow_config_transformer_Alpha158.yaml](file://examples/benchmarks/Transformer/workflow_config_transformer_Alpha158.yaml)
- [workflow_config_lstm_Alpha158.yaml](file://examples/benchmarks/LSTM/workflow_config_lstm_Alpha158.yaml)
- [workflow_config_mlp_Alpha158.yaml](file://examples/benchmarks/MLP/workflow_config_mlp_Alpha158.yaml)
- [workflow_config_linear_Alpha158.yaml](file://examples/benchmarks/Linear/workflow_config_linear_Alpha158.yaml)
- [TRA/example.py](file://examples/benchmarks/TRA/example.py)
- [rl_order_execution/README.md](file://examples/rl_order_execution/README.md)
- [highfreq/README.md](file://examples/highfreq/README.md)
- [benchmarks_dynamic/README.md](file://examples/benchmarks_dynamic/README.md)
- [run_all_model.py](file://examples/run_all_model.py)
</cite>

## 目录
1. [渐进式模型教程](#渐进式模型教程)
2. [基准模型独立教程](#基准模型独立教程)
3. [高级示例详解](#高级示例详解)
4. [动态基准测试](#动态基准测试)
5. [批量运行与结果分析](#批量运行与结果分析)

## 渐进式模型教程

本节提供从简单到复杂的渐进式教程，涵盖线性模型到深度学习模型的演进路径。通过系统化的学习路径，用户可以逐步掌握量化投资模型的构建与优化方法。

### 线性模型入门

线性模型作为最基础的预测模型，是理解量化投资建模的起点。该模型通过线性组合特征来预测股票收益，其简单性和可解释性使其成为初学者的理想选择。

**学习目标**：
- 理解线性回归在量化投资中的应用
- 掌握配置文件的基本结构
- 学会解读模型输出结果

**步骤说明**：
1. 配置数据处理流程，包括特征标准化和缺失值填充
2. 设置模型参数，选择普通最小二乘法(OLS)作为估计器
3. 定义回测策略和评估指标

**结果分析**：
线性模型在Alpha158数据集上的表现提供了基准性能参考。通过IC（信息系数）和年化收益率等指标，可以评估模型的预测能力和投资价值。

**本节来源**
- [workflow_config_linear_Alpha158.yaml](file://examples/benchmarks/Linear/workflow_config_linear_Alpha158.yaml)

### 多层感知机(MLP)进阶

多层感知机作为第一个非线性模型，引入了神经网络的概念。相比线性模型，MLP能够捕捉特征间的非线性关系，提升预测精度。

**学习目标**：
- 理解神经网络的基本架构
- 掌握深度学习模型的超参数调优
- 学会处理过拟合问题

**步骤说明**：
1. 配置深度神经网络模型，设置输入维度为157（Alpha158特征数）
2. 调整学习率、批量大小和正则化参数
3. 监控训练过程中的损失函数变化

**结果分析**：
MLP模型在CSI300指数上的表现优于线性模型，特别是在信息比率和最大回撤方面。这表明非线性模型能够更好地捕捉市场动态。

**本节来源**
- [workflow_config_mlp_Alpha158.yaml](file://examples/benchmarks/MLP/workflow_config_mlp_Alpha158.yaml)

### 循环神经网络深化

循环神经网络(RNN)家族模型专门用于处理时间序列数据。通过引入时间维度的依赖关系，这些模型能够捕捉价格走势的动态特征。

**学习目标**：
- 理解RNN处理时间序列的优势
- 掌握LSTM和GRU的内部机制
- 学会配置时间序列数据集

**步骤说明**：
1. 使用TSDatasetH处理器创建时间序列数据
2. 设置时间步长(step_len)为20个交易日
3. 配置LSTM或GRU网络的隐藏层大小和层数

**结果分析**：
LSTM和GRU模型在Alpha158数据集上表现出色，特别是当使用20个精选特征时。这表明时间序列模型能够有效利用历史价格信息。

**本节来源**
- [workflow_config_lstm_Alpha158.yaml](file://examples/benchmarks/LSTM/workflow_config_lstm_Alpha158.yaml)

## 基准模型独立教程

### ALSTM模型教程

ALSTM(Attention-based LSTM)模型结合了LSTM的记忆能力和注意力机制的选择性关注特性，能够自动识别对预测最重要的时间步。

**模型架构**：
ALSTM在标准LSTM基础上增加了时间注意力聚合层，允许模型在不同时间步分配不同的权重。这种结构特别适合金融时间序列预测，因为并非所有历史数据都同等重要。

**配置文件结构**：
```yaml
model:
  class: ALSTM
  module_path: qlib.contrib.model.pytorch_alstm_ts
  kwargs:
    d_feat: 20
    hidden_size: 64
    num_layers: 2
    dropout: 0.0
    n_epochs: 200
    lr: 1e-3
    early_stop: 10
    batch_size: 800
```

**预期结果**：
在Alpha158数据集上，ALSTM模型展现出优异的预测能力，其信息比率达到0.6992±0.47，显著优于基础LSTM模型。这证明了注意力机制在金融预测中的有效性。

**本节来源**
- [ALSTM/README.md](file://examples/benchmarks/ALSTM/README.md)
- [workflow_config_alstm_Alpha158.yaml](file://examples/benchmarks/ALSTM/workflow_config_alstm_Alpha158.yaml)

### Transformer模型教程

Transformer模型基于自注意力机制，彻底改变了序列建模的方式。与RNN不同，Transformer可以并行处理所有时间步，大大提高了训练效率。

**模型架构**：
Transformer使用多头自注意力机制来捕捉序列中任意两个位置之间的依赖关系，无论它们的距离有多远。这种全局视野使其在处理长序列时具有优势。

**配置文件结构**：
```yaml
model:
  class: TransformerModel
  module_path: qlib.contrib.model.pytorch_transformer_ts
  kwargs:
    seed: 0
    n_jobs: 20
```

**预期结果**：
尽管Transformer在Alpha158数据集上的表现略逊于ALSTM，但其架构的可扩展性为未来优化提供了巨大空间。特别是在处理更长的时间序列时，Transformer可能展现出更强的性能。

**本节来源**
- [Transformer/README.md](file://examples/benchmarks/Transformer/README.md)
- [workflow_config_transformer_Alpha158.yaml](file://examples/benchmarks/Transformer/workflow_config_transformer_Alpha158.yaml)

## 高级示例详解

### 强化学习订单执行

强化学习订单执行示例展示了如何使用深度强化学习优化交易执行策略。该框架将订单执行问题建模为马尔可夫决策过程。

**核心组件**：
- **PPO算法**：基于近端策略优化的训练方法，提供稳定的策略更新
- **OPDS方法**：基于Oracle策略蒸馏的通用交易框架
- **TWAP基准**：时间加权平均价格作为传统执行策略的对比基准

**工作流程**：
1. 数据预处理：将原始市场数据转换为pickle格式
2. 模型训练：使用PPO或OPDS算法训练执行策略
3. 回测验证：在真实市场模拟器中测试训练好的策略

**性能对比**：
| 模型 | 价格优势(PA)均值±标准差 |
|------|------------------------|
| OPDS(PPO策略) | 0.4785 ± 0.7815 |
| OPDS(DQN策略) | -0.0114 ± 0.5780 |
| PPO | -1.0935 ± 0.0922 |
| TWAP | ≈ 0.0 ± 0.0 |

**本节来源**
- [rl_order_execution/README.md](file://examples/rl_order_execution/README.md)

### 高频交易示例

高频交易示例展示了如何处理和分析5分钟级别的高频数据。该示例特别关注价格趋势预测。

**数据获取**：
通过以下命令获取高频数据：
```bash
python workflow.py get_data
```

**数据集特性**：
- 时间频率：5分钟
- 数据类型：包含开盘价、最高价、最低价、收盘价和成交量
- 处理方式：支持序列化存储和重新初始化

**性能基准**：
LightGBM模型在高频数据上的表现：
- IC：0.0349±0.00
- ICIR：0.3805±0.00
- 多空平均夏普比率：0.2677±0.00

**本节来源**
- [highfreq/README.md](file://examples/highfreq/README.md)

## 动态基准测试

由于金融市场的非平稳性，数据分布在不同时期可能发生改变，导致基于历史数据训练的模型性能衰减。动态基准测试解决了这一挑战。

**解决方案对比**：
| 模型名称 | IC | ICIR | 年化收益率 | 信息比率 | 最大回撤 |
|---------|-----|------|-----------|---------|---------|
| RR[Linear] | 0.0945 | 0.5989 | 0.0857 | 1.3682 | -0.0986 |
| DDG-DA[Linear] | 0.0983 | 0.6157 | 0.0764 | 1.1904 | -0.0769 |
| RR[LightGBM] | 0.0816 | 0.5887 | 0.0771 | 1.3196 | -0.0909 |
| DDG-DA[LightGBM] | 0.0878 | 0.6185 | 0.1261 | 2.0096 | -0.0744 |

**关键参数**：
- 标签预测周期：20个交易日
- 滚动时间间隔：20个交易日
- 测试周期：2017年1月至2020年8月

**本节来源**
- [benchmarks_dynamic/README.md](file://examples/benchmarks_dynamic/README.md)

## 批量运行与结果分析

`run_all_model.py`脚本提供了批量运行和评估多个模型的能力，支持自动化实验管理和结果汇总。

**主要功能**：
- 支持指定运行次数（默认20次以获得统计显著性）
- 自动创建隔离的conda环境
- 依赖项自动安装
- 结果自动收集和统计分析

**使用示例**：
```bash
# 运行所有模型3次
python run_all_model.py run 3

# 运行特定模型
python run_all_model.py run 3 lightgbm Alpha158 csi500

# 排除指定模型运行
python run_all_model.py run 3 [mlp,tft,lstm] --exclude=True
```

**结果生成**：
脚本自动生成包含均值和标准差的Markdown表格，便于结果比较和报告撰写。

**本节来源**
- [run_all_model.py](file://examples/run_all_model.py)