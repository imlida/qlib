# 安全反序列化工具

<cite>
**本文档中引用的文件**  
- [pickle_utils.py](file://qlib/utils/pickle_utils.py)
- [serial.py](file://qlib/utils/serial.py)
- [native.py](file://qlib/rl/data/native.py)
- [pickle_styled.py](file://qlib/rl/data/pickle_styled.py)
- [cache.py](file://qlib/data/cache.py)
- [mod.py](file://qlib/utils/mod.py)
- [objm.py](file://qlib/utils/objm.py)
- [serial.rst](file://docs/advanced/serial.rst)
- [workflow.py](file://examples/highfreq/workflow.py)
</cite>

## 目录
1. [简介](#简介)
2. [安全反序列化机制](#安全反序列化机制)
3. [核心组件分析](#核心组件分析)
4. [序列化框架](#序列化框架)
5. [使用示例](#使用示例)
6. [安全策略](#安全策略)
7. [依赖分析](#依赖分析)

## 简介
Qlib 提供了一套完整的序列化和反序列化工具，用于在磁盘上保存和加载各种组件的状态，如数据处理器、数据集、模型等。为了防止恶意代码执行，Qlib 实现了安全的反序列化机制，通过限制可反序列化的类来增强安全性。

## 安全反序列化机制

Qlib 的安全反序列化机制主要通过 `qlib.utils.pickle_utils` 模块实现，该模块提供了安全的反序列化函数，防止任意代码执行。

```mermaid
classDiagram
class RestrictedUnpickler {
+find_class(module : str, name : str)
}
class RestrictedUnpickler : : find_class {
+module : str
+name : str
}
class restricted_pickle_load {
+file : BinaryIO
}
class restricted_pickle_loads {
+data : bytes
}
RestrictedUnpickler --> restricted_pickle_load : "使用"
RestrictedUnpickler --> restricted_pickle_loads : "使用"
restricted_pickle_load --> "BinaryIO" : "输入"
restricted_pickle_loads --> "bytes" : "输入"
```

**图示来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py#L61-L141)

**本节来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py#L1-L172)

## 核心组件分析

### RestrictedUnpickler 类
`RestrictedUnpickler` 是一个自定义的反序列化器，它继承自 `pickle.Unpickler`，通过重写 `find_class` 方法来限制可反序列化的类。

```mermaid
classDiagram
class RestrictedUnpickler {
+find_class(module : str, name : str)
}
class SAFE_PICKLE_CLASSES {
+("builtins", "dict")
+("builtins", "list")
+("builtins", "tuple")
+("datetime", "datetime")
+("pandas", "*")
+("numpy", "*")
}
class TRUSTED_MODULE_PREFIXES {
+"pandas"
+"numpy"
}
RestrictedUnpickler --> SAFE_PICKLE_CLASSES : "检查"
RestrictedUnpickler --> TRUSTED_MODULE_PREFIXES : "检查"
```

**图示来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py#L16-L58)

### 安全反序列化函数
Qlib 提供了两个主要的安全反序列化函数：

```mermaid
flowchart TD
Start([开始]) --> CheckInput["检查输入参数"]
CheckInput --> InputValid{"输入有效?"}
InputValid --> |否| ReturnError["返回错误"]
InputValid --> |是| CreateStream["创建字节流"]
CreateStream --> LoadData["使用 RestrictedUnpickler 加载数据"]
LoadData --> ValidateClass["验证类是否在白名单中"]
ValidateClass --> ClassAllowed{"类被允许?"}
ClassAllowed --> |否| RaiseError["抛出 UnpicklingError"]
ClassAllowed --> |是| ReturnData["返回反序列化对象"]
ReturnError --> End([结束])
ReturnData --> End
RaiseError --> End
```

**图示来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py#L99-L141)

**本节来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py#L99-L172)

## 序列化框架

Qlib 的序列化框架基于 `Serializable` 基类，为各种组件提供统一的序列化接口。

```mermaid
classDiagram
class Serializable {
+pickle_backend : str
+default_dump_all : bool
+config_attr : list
+exclude_attr : list
+include_attr : list
+__getstate__()
+__setstate__(state : dict)
+config(recursive : bool, **kwargs)
+to_pickle(path : Union[Path, str], **kwargs)
+load(filepath)
+get_backend()
+general_dump(obj, path : Union[Path, str])
}
class DataHandler {
+to_pickle()
+load()
}
class DatasetH {
+to_pickle()
+load()
}
class Model {
+to_pickle()
+load()
}
Serializable <|-- DataHandler
Serializable <|-- DatasetH
Serializable <|-- Model
```

**图示来源**
- [serial.py](file://qlib/utils/serial.py#L11-L190)

**本节来源**
- [serial.py](file://qlib/utils/serial.py#L1-L190)

## 使用示例

### 序列化和反序列化数据集
以下示例展示了如何使用 Qlib 的序列化功能保存和加载数据集：

```mermaid
sequenceDiagram
participant User as "用户"
participant Dataset as "DatasetH"
participant File as "文件系统"
User->>Dataset : to_pickle(path="dataset.pkl")
Dataset->>File : 打开文件并写入
File-->>Dataset : 文件写入完成
Dataset-->>User : 序列化完成
User->>File : 打开"dataset.pkl"读取
File-->>User : 返回文件对象
User->>Dataset : pickle.load(file_object)
Dataset-->>User : 返回反序列化对象
```

**图示来源**
- [workflow.py](file://examples/highfreq/workflow.py#L120-L131)
- [serial.rst](file://docs/advanced/serial.rst#L28-L33)

### 安全反序列化使用
在需要安全反序列化的场景中，应使用 `restricted_pickle_load` 函数：

```mermaid
flowchart TD
Start([开始]) --> OpenFile["打开 pickle 文件"]
OpenFile --> CreateUnpickler["创建 RestrictedUnpickler 实例"]
CreateUnpickler --> LoadData["调用 load() 方法"]
LoadData --> CheckClass["检查类是否在白名单中"]
CheckClass --> ClassAllowed{"类被允许?"}
ClassAllowed --> |否| RaiseSecurityError["抛出安全错误"]
ClassAllowed --> |是| CreateInstance["创建对象实例"]
CreateInstance --> ReturnObject["返回对象"]
RaiseSecurityError --> End([结束])
ReturnObject --> End
```

**本节来源**
- [native.py](file://qlib/rl/data/native.py#L16)
- [pickle_styled.py](file://qlib/rl/data/pickle_styled.py#L263)
- [cache.py](file://qlib/data/cache.py#L227)

## 安全策略

Qlib 的安全反序列化策略基于白名单机制，确保只有受信任的类可以被反序列化。

### 白名单机制
```mermaid
graph TD
A[反序列化请求] --> B{模块前缀检查}
B --> |pandas/numpy| C[允许反序列化]
B --> |其他模块| D{类名检查}
D --> |在 SAFE_PICKLE_CLASSES 中| C
D --> |不在 SAFE_PICKLE_CLASSES 中| E[拒绝反序列化]
C --> F[成功反序列化]
E --> G[抛出 UnpicklingError]
```

**本节来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py#L55-L96)

### 可扩展的安全策略
Qlib 提供了扩展安全策略的接口，允许用户添加自定义的可信类：

```mermaid
classDiagram
class add_safe_class {
+module : str
+name : str
}
class get_safe_classes {
+返回当前白名单
}
add_safe_class --> SAFE_PICKLE_CLASSES : "添加"
get_safe_classes --> SAFE_PICKLE_CLASSES : "查询"
```

**本节来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py#L144-L171)

## 依赖分析

Qlib 的安全反序列化工具与其他组件有紧密的依赖关系：

```mermaid
graph TD
A[pickle_utils.py] --> B[serial.py]
A --> C[native.py]
A --> D[pickle_styled.py]
A --> E[cache.py]
A --> F[mod.py]
A --> G[objm.py]
B --> H[DataHandler]
B --> I[DatasetH]
B --> J[Model]
C --> K[IntradayBacktestData]
D --> L[SimpleIntradayBacktestData]
E --> M[DatasetCache]
F --> N[get_callable_kwargs]
G --> O[load_obj]
```

**图示来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py)
- [serial.py](file://qlib/utils/serial.py)
- [native.py](file://qlib/rl/data/native.py)
- [pickle_styled.py](file://qlib/rl/data/pickle_styled.py)
- [cache.py](file://qlib/data/cache.py)
- [mod.py](file://qlib/utils/mod.py)
- [objm.py](file://qlib/utils/objm.py)

**本节来源**
- [pickle_utils.py](file://qlib/utils/pickle_utils.py#L1-L172)
- [serial.py](file://qlib/utils/serial.py#L1-L190)
- [native.py](file://qlib/rl/data/native.py#L1-L235)
- [pickle_styled.py](file://qlib/rl/data/pickle_styled.py#L1-L297)
- [cache.py](file://qlib/data/cache.py#L1-L1199)
- [mod.py](file://qlib/utils/mod.py#L1-L241)
- [objm.py](file://qlib/utils/objm.py#L1-L120)